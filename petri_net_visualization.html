<!DOCTYPE html>
<html>
<head>
  <title>Petri Net Visualization</title>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.19.1/cytoscape.min.js'></script>
  <style>
    #cy {
      width: 80vw;
      height: 100vh;
      border: 1px solid black;
      float: left;
    }
    #functionInfo {
      width: 19vw;
      height: 100vh;
      float: right;
      overflow-y: scroll;
      border: 1px solid black;
    }
    #container {
        display: grid;
        grid-template-columns: 4fr 1fr;
    }
  </style>
</head>
<body>

<div>
  <label for="searchBox">Search: </label>
  <input type="text" id="searchBox">
</div>
<div id="container">
  <div id='cy'></div>
  <div id='functionInfo'>Edge expression panel, click to see</div>
</div>


<script>
  var cy = cytoscape({
    container: document.getElementById('cy'),
    elements: [
      { data: { id: 'psDrain', type: 'place' } },
      { data: { id: 'pstore_cap', type: 'place' } },
      { data: { id: 'pstore_inst_q', type: 'place' } },
      { data: { id: 'pcontrol_prime', type: 'place' } },
      { data: { id: 'pcontrol', type: 'place' } },
      { data: { id: 'psReadCmd', type: 'place' } },
      { data: { id: 'pfetch_0', type: 'place' } },
      { data: { id: 'pfetch_cmd', type: 'place' } },
      { data: { id: 'plaunch', type: 'place' } },
      { data: { id: 'pload_cap', type: 'place' } },
      { data: { id: 'pload_inst_q', type: 'place' } },
      { data: { id: 'pcompute_cap', type: 'place' } },
      { data: { id: 'pcompute_inst_q', type: 'place' } },
      { data: { id: 'pcompute_idle', type: 'place' } },
      { data: { id: 'pstore2compute', type: 'place' } },
      { data: { id: 'pload2compute', type: 'place' } },
      { data: { id: 'pcompute_0', type: 'place' } },
      { data: { id: 'pcompute_sync', type: 'place' } },
      { data: { id: 'pcompute_2', type: 'place' } },
      { data: { id: 'pcompute_dep', type: 'place' } },
      { data: { id: 'pcompute_exe', type: 'place' } },
      { data: { id: 'pcompute_done', type: 'place' } },
      { data: { id: 'pcompute_3', type: 'place' } },
      { data: { id: 'pstore_idle', type: 'place' } },
      { data: { id: 'pcompute2store', type: 'place' } },
      { data: { id: 'pstore_0', type: 'place' } },
      { data: { id: 'pstore_sync', type: 'place' } },
      { data: { id: 'pstore_2', type: 'place' } },
      { data: { id: 'pstore_dep', type: 'place' } },
      { data: { id: 'pstore_exe', type: 'place' } },
      { data: { id: 'pstore_done', type: 'place' } },
      { data: { id: 'pload_idle', type: 'place' } },
      { data: { id: 'pcompute2load', type: 'place' } },
      { data: { id: 'pload_0', type: 'place' } },
      { data: { id: 'pload_sync', type: 'place' } },
      { data: { id: 'pload_2', type: 'place' } },
      { data: { id: 'pload_dep', type: 'place' } },
      { data: { id: 'pload_exe', type: 'place' } },
      { data: { id: 'pload_done', type: 'place' } },
      { data: { id: 'pload_mem', type: 'place' } },
      { data: { id: 'pcompute_tsload_allcmd', type: 'place' } },
      { data: { id: 'pcompute_tsload_start', type: 'place' } },
      { data: { id: 'pcompute_tsload_inflight', type: 'place' } },
      { data: { id: 'ptsload_valid', type: 'place' } },
      { data: { id: 'psink', type: 'place' } },
      { data: { id: 'pcompute_tsload_busy', type: 'place' } },
      { data: { id: 'pdpi_cap', type: 'place' } },
      { data: { id: 'pdram_cmd', type: 'place' } },
      { data: { id: 'pdram_out', type: 'place' } },
      { data: { id: 'pdram_req_queue_ready', type: 'place' } },
      { data: { id: 'pdram_readData', type: 'place' } },
      { data: { id: 'pdram_idle', type: 'place' } },
      { data: { id: 'pdram_req_queue', type: 'place' } },
      { data: { id: 'pdram_1', type: 'place' } },
      { data: { id: 'pdram_2', type: 'place' } },
      { data: { id: 'pdram_0', type: 'place' } },
      { data: { id: 'pfetch_done', type: 'place' } },
      { data: { id: 'pnumInsn', type: 'place' } },
      { data: { id: 'pfetch_tsload_allcmd', type: 'place' } },
      { data: { id: 'pfetch_tsload_start', type: 'place' } },
      { data: { id: 'pfetch_tsload_inflight', type: 'place' } },
      { data: { id: 'pfetch_tsload_busy', type: 'place' } },
      { data: { id: 'pload_tsload_allcmd', type: 'place' } },
      { data: { id: 'pload_tsload_start', type: 'place' } },
      { data: { id: 'pload_tsload_inflight', type: 'place' } },
      { data: { id: 'pload_tsload_busy', type: 'place' } },
      { data: { id: '16', type: 'transition' } },
      { data: { id: '12', type: 'transition' } },
      { data: { id: '9', type: 'transition' } },
      { data: { id: '13', type: 'transition' } },
      { data: { id: '14', type: 'transition' } },
      { data: { id: '15', type: 'transition' } },
      { data: { id: 'compute_launch', type: 'transition' } },
      { data: { id: 'compute_5', type: 'transition' } },
      { data: { id: 'compute_1', type: 'transition' } },
      { data: { id: 'compute_3', type: 'transition' } },
      { data: { id: 'compute_4', type: 'transition' } },
      { data: { id: 'compute_7', type: 'transition' } },
      { data: { id: 'ALU', type: 'transition' } },
      { data: { id: 'Gemm', type: 'transition' } },
      { data: { id: 'loadUop', type: 'transition' } },
      { data: { id: 'loadAcc_dram', type: 'transition' } },
      { data: { id: 'store_launch', type: 'transition' } },
      { data: { id: 'store_5', type: 'transition' } },
      { data: { id: 'store_1', type: 'transition' } },
      { data: { id: 'store_3', type: 'transition' } },
      { data: { id: 'store_4', type: 'transition' } },
      { data: { id: 'store_7', type: 'transition' } },
      { data: { id: 'store_store', type: 'transition' } },
      { data: { id: 'load_launch', type: 'transition' } },
      { data: { id: 'load_5', type: 'transition' } },
      { data: { id: 'load_1', type: 'transition' } },
      { data: { id: 'load_3', type: 'transition' } },
      { data: { id: 'load_4', type: 'transition' } },
      { data: { id: 'load_7', type: 'transition' } },
      { data: { id: 'load_load', type: 'transition' } },
      { data: { id: 'compute_dep', type: 'transition' } },
      { data: { id: 'store_dep', type: 'transition' } },
      { data: { id: 'load_dep', type: 'transition' } },
      { data: { id: 'compute_dep_sync', type: 'transition' } },
      { data: { id: 'store_dep_sync', type: 'transition' } },
      { data: { id: 'load_dep_sync', type: 'transition' } },
      { data: { id: 'compute_tsload_8', type: 'transition' } },
      { data: { id: 'compute_tsload_9', type: 'transition' } },
      { data: { id: 'compute_tsload_7', type: 'transition' } },
      { data: { id: 'compute_tsload_5', type: 'transition' } },
      { data: { id: 'compute_tsload_4', type: 'transition' } },
      { data: { id: 'tsload_6', type: 'transition' } },
      { data: { id: 'dram_0', type: 'transition' } },
      { data: { id: 'dram_1', type: 'transition' } },
      { data: { id: 'dram_2', type: 'transition' } },
      { data: { id: 'dram_3', type: 'transition' } },
      { data: { id: 'dram_10', type: 'transition' } },
      { data: { id: 'dram_enq_deq_valid', type: 'transition' } },
      { data: { id: 'dram_deq', type: 'transition' } },
      { data: { id: 'fetch_done', type: 'transition' } },
      { data: { id: 'fetch_tsload_8', type: 'transition' } },
      { data: { id: 'fetch_tsload_9', type: 'transition' } },
      { data: { id: 'fetch_tsload_7', type: 'transition' } },
      { data: { id: 'fetch_tsload_5', type: 'transition' } },
      { data: { id: 'fetch_tsload_4', type: 'transition' } },
      { data: { id: 'load_tsload_8', type: 'transition' } },
      { data: { id: 'load_tsload_9', type: 'transition' } },
      { data: { id: 'load_tsload_7', type: 'transition' } },
      { data: { id: 'load_tsload_5', type: 'transition' } },
      { data: { id: 'load_tsload_4', type: 'transition' } },
      { data: { id: 'e_psDrain_16', source: 'psDrain', target: '16', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pstore_cap_16', source: 'pstore_cap', target: '16', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_16_pstore_inst_q', source: '16', target: 'pstore_inst_q', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_psDrain_12', source: 'psDrain', target: '12', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pcontrol_prime_12', source: 'pcontrol_prime', target: '12', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_12_pcontrol', source: '12', target: 'pcontrol', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_psReadCmd_9', source: 'psReadCmd', target: '9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcontrol_9', source: 'pcontrol', target: '9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_9_pfetch_0', source: '9', target: 'pfetch_0', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_9_pfetch_cmd', source: '9', target: 'pfetch_cmd', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_plaunch_13', source: 'plaunch', target: '13', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_13_psReadCmd', source: '13', target: 'psReadCmd', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        total_insn = binding[f\"plaunch.0.total_insn\"]\n        \n        # edge expression: \n        max_insn = 8\n        ites = total_insn // max_insn\n        remain = total_insn % max_insn\n\n        # clearly variable edges\n        tokens = deque()\n        [tokens.append(Token(dict({\"insn_count\":max_insn}))) for i in range(ites)] \n        if remain > 0:\n            tokens.append(Token(dict({\"insn_count\":remain})))  \n        # output_queue.append(Token(dict({\"insn_count\":total_insn}))) \n        return tokens \n" } },
      { data: { id: 'e_psDrain_14', source: 'psDrain', target: '14', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pload_cap_14', source: 'pload_cap', target: '14', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_14_pload_inst_q', source: '14', target: 'pload_inst_q', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_psDrain_15', source: 'psDrain', target: '15', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute_cap_15', source: 'pcompute_cap', target: '15', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_15_pcompute_inst_q', source: '15', target: 'pcompute_inst_q', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pcompute_inst_q_compute_launch', source: 'pcompute_inst_q', target: 'compute_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute_idle_compute_launch', source: 'pcompute_idle', target: 'compute_launch', label: 'weight', functionBody: "    def weight(binding):\n        return constant\n" } },
      { data: { id: 'e_pstore2compute_compute_launch', source: 'pstore2compute', target: 'compute_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        # direc is pop_next or pop_prev\n        key = f\"{dependent_place.id}.0.{direc}\"\n        # if key not in binding, incorrect evaluation order\n        # if key not in binding:\n        #     return -1 #unable to fire\n        return MUX(binding[key] == 1, 1, 0)\n" } },
      { data: { id: 'e_pload2compute_compute_launch', source: 'pload2compute', target: 'compute_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        # direc is pop_next or pop_prev\n        key = f\"{dependent_place.id}.0.{direc}\"\n        # if key not in binding, incorrect evaluation order\n        # if key not in binding:\n        #     return -1 #unable to fire\n        return MUX(binding[key] == 1, 1, 0)\n" } },
      { data: { id: 'e_compute_launch_pcompute_0', source: 'compute_launch', target: 'pcompute_0', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pcompute_sync_compute_5', source: 'pcompute_sync', target: 'compute_5', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_5_pcompute_idle', source: 'compute_5', target: 'pcompute_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_compute_5_pcompute_cap', source: 'compute_5', target: 'pcompute_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_0_compute_1', source: 'pcompute_0', target: 'compute_1', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_1_pcompute_2', source: 'compute_1', target: 'pcompute_2', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_compute_1_pcompute_dep', source: 'compute_1', target: 'pcompute_dep', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pcompute_2_compute_3', source: 'pcompute_2', target: 'compute_3', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_3_pcompute_sync', source: 'compute_3', target: 'pcompute_sync', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_0_compute_4', source: 'pcompute_0', target: 'compute_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_4_pcompute_exe', source: 'compute_4', target: 'pcompute_exe', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_done_compute_7', source: 'pcompute_done', target: 'compute_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute_exe_compute_7', source: 'pcompute_exe', target: 'compute_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_7_pcompute_idle', source: 'compute_7', target: 'pcompute_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_compute_7_pcompute_cap', source: 'compute_7', target: 'pcompute_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_2_ALU', source: 'pcompute_2', target: 'ALU', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_ALU_pcompute_done', source: 'ALU', target: 'pcompute_done', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_2_Gemm', source: 'pcompute_2', target: 'Gemm', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_Gemm_pcompute_done', source: 'Gemm', target: 'pcompute_done', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_2_loadUop', source: 'pcompute_2', target: 'loadUop', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_loadUop_pcompute_3', source: 'loadUop', target: 'pcompute_3', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pcompute_2_loadAcc_dram', source: 'pcompute_2', target: 'loadAcc_dram', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_loadAcc_dram_pcompute_3', source: 'loadAcc_dram', target: 'pcompute_3', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pstore_inst_q_store_launch', source: 'pstore_inst_q', target: 'store_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pstore_idle_store_launch', source: 'pstore_idle', target: 'store_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute2store_store_launch', source: 'pcompute2store', target: 'store_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        # direc is pop_next or pop_prev\n        key = f\"{dependent_place.id}.0.{direc}\"\n        # if key not in binding, incorrect evaluation order\n        # if key not in binding:\n        #     return -1 #unable to fire\n        return MUX(binding[key] == 1, 1, 0)\n" } },
      { data: { id: 'e_store_launch_pstore_0', source: 'store_launch', target: 'pstore_0', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pstore_sync_store_5', source: 'pstore_sync', target: 'store_5', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_5_pstore_idle', source: 'store_5', target: 'pstore_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_store_5_pstore_cap', source: 'store_5', target: 'pstore_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pstore_0_store_1', source: 'pstore_0', target: 'store_1', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_1_pstore_2', source: 'store_1', target: 'pstore_2', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_store_1_pstore_dep', source: 'store_1', target: 'pstore_dep', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pstore_2_store_3', source: 'pstore_2', target: 'store_3', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_3_pstore_sync', source: 'store_3', target: 'pstore_sync', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pstore_0_store_4', source: 'pstore_0', target: 'store_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_4_pstore_exe', source: 'store_4', target: 'pstore_exe', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pstore_done_store_7', source: 'pstore_done', target: 'store_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pstore_exe_store_7', source: 'pstore_exe', target: 'store_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_7_pstore_idle', source: 'store_7', target: 'pstore_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_store_7_pstore_cap', source: 'store_7', target: 'pstore_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pstore_2_store_store', source: 'pstore_2', target: 'store_store', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_store_pstore_done', source: 'store_store', target: 'pstore_done', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_inst_q_load_launch', source: 'pload_inst_q', target: 'load_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pload_idle_load_launch', source: 'pload_idle', target: 'load_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute2load_load_launch', source: 'pcompute2load', target: 'load_launch', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        # direc is pop_next or pop_prev\n        key = f\"{dependent_place.id}.0.{direc}\"\n        # if key not in binding, incorrect evaluation order\n        # if key not in binding:\n        #     return -1 #unable to fire\n        return MUX(binding[key] == 1, 1, 0)\n" } },
      { data: { id: 'e_load_launch_pload_0', source: 'load_launch', target: 'pload_0', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pload_sync_load_5', source: 'pload_sync', target: 'load_5', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_5_pload_idle', source: 'load_5', target: 'pload_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_load_5_pload_cap', source: 'load_5', target: 'pload_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_0_load_1', source: 'pload_0', target: 'load_1', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_1_pload_2', source: 'load_1', target: 'pload_2', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_load_1_pload_dep', source: 'load_1', target: 'pload_dep', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pload_2_load_3', source: 'pload_2', target: 'load_3', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_3_pload_sync', source: 'load_3', target: 'pload_sync', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_0_load_4', source: 'pload_0', target: 'load_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_4_pload_exe', source: 'load_4', target: 'pload_exe', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_done_load_7', source: 'pload_done', target: 'load_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pload_exe_load_7', source: 'pload_exe', target: 'load_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_7_pload_idle', source: 'load_7', target: 'pload_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_load_7_pload_cap', source: 'load_7', target: 'pload_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_2_load_load', source: 'pload_2', target: 'load_load', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_load_pload_mem', source: 'load_load', target: 'pload_mem', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pcompute_dep_compute_dep', source: 'pcompute_dep', target: 'compute_dep', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute_done_compute_dep', source: 'pcompute_done', target: 'compute_dep', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_dep_pcompute2store', source: 'compute_dep', target: 'pcompute2store', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_compute_dep_pcompute2load', source: 'compute_dep', target: 'pcompute2load', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_pstore_dep_store_dep', source: 'pstore_dep', target: 'store_dep', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pstore_done_store_dep', source: 'pstore_done', target: 'store_dep', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_dep_pstore2compute', source: 'store_dep', target: 'pstore2compute', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_pload_dep_load_dep', source: 'pload_dep', target: 'load_dep', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pload_done_load_dep', source: 'pload_done', target: 'load_dep', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_dep_pload2compute', source: 'load_dep', target: 'pload2compute', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_pcompute_dep_compute_dep_sync', source: 'pcompute_dep', target: 'compute_dep_sync', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pcompute_sync_compute_dep_sync', source: 'pcompute_sync', target: 'compute_dep_sync', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_dep_sync_pcompute2store', source: 'compute_dep_sync', target: 'pcompute2store', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_compute_dep_sync_pcompute2load', source: 'compute_dep_sync', target: 'pcompute2load', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_pstore_dep_store_dep_sync', source: 'pstore_dep', target: 'store_dep_sync', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pstore_sync_store_dep_sync', source: 'pstore_sync', target: 'store_dep_sync', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_store_dep_sync_pstore2compute', source: 'store_dep_sync', target: 'pstore2compute', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_pload_dep_load_dep_sync', source: 'pload_dep', target: 'load_dep_sync', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pload_sync_load_dep_sync', source: 'pload_sync', target: 'load_dep_sync', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_dep_sync_pload2compute', source: 'load_dep_sync', target: 'pload2compute', label: 'output_token', functionBody: "    def output_token(binding):\n        key = f\"{dependent_place.id}.0.{direc}\"\n        #direc is push_next or push_prev\n        if binding[key] == 1:\n            tokens = deque()\n            tokens.append(Token())\n            return tokens\n        return None\n" } },
      { data: { id: 'e_pcompute_3_compute_tsload_8', source: 'pcompute_3', target: 'compute_tsload_8', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_tsload_8_pcompute_tsload_allcmd', source: 'compute_tsload_8', target: 'pcompute_tsload_allcmd', label: 'output_token', functionBody: "    def output_token(binding):\n\n        subopcode = binding[f\"{dependent_place.id}.0.subopcode\"]\n        opcode = binding[f\"{dependent_place.id}.0.opcode\"]\n        tstype = binding[f\"{dependent_place.id}.0.tstype\"]\n        xsize = int(binding[f\"{dependent_place.id}.0.xsize\"])\n        ysize = int(binding[f\"{dependent_place.id}.0.ysize\"])\n\n        tsSize = 32\n        if opcode == \"compute\" and subopcode == \"loadUop\":\n            tsSize = 1*1*32\n        if opcode == \"compute\" and subopcode == \"loadAcc\":\n            tsSize = 1*16*32\n        if opcode == \"load\" and tstype == \"inp\":\n            tsSize = 1*16*8\n        if opcode == \"load\" and tstype == \"wgt\":\n            tsSize = 16*16*8\n\n        maxtransfer = 16*64 #16cache*64bits \n        one_row_size = tsSize*xsize\n        if one_row_size > maxtransfer:\n            remain_len = int(math.ceil(one_row_size % maxtransfer / 64))\n            datalen = int(maxtransfer/64)\n            cmd_times = int(one_row_size // maxtransfer)\n        else:\n            remain_len = 0\n            datalen = int(math.ceil(one_row_size/64))\n            cmd_times = 1 \n\n        tokens = deque()\n        for i in range(ysize) :\n            for j in range(cmd_times):\n                cmdToken = Token()\n                cmdToken.dir[\"req_len\"] = datalen\n                cmdToken.dir[\"addr\"] = addr\n                tokens.append(cmdToken)\n            if remain_len > 0:\n                cmdToken = Token()\n                cmdToken.dir[\"req_len\"] = remain_len\n                cmdToken.dir[\"addr\"] = addr\n                tokens.append(cmdToken)\n        return tokens\n" } },
      { data: { id: 'e_compute_tsload_8_pcompute_tsload_start', source: 'compute_tsload_8', target: 'pcompute_tsload_start', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_tsload_inflight_compute_tsload_9', source: 'pcompute_tsload_inflight', target: 'compute_tsload_9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_ptsload_valid_compute_tsload_9', source: 'ptsload_valid', target: 'compute_tsload_9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_tsload_9_psink', source: 'compute_tsload_9', target: 'psink', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_tsload_inflight_compute_tsload_7', source: 'pcompute_tsload_inflight', target: 'compute_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pcompute_tsload_allcmd_compute_tsload_7', source: 'pcompute_tsload_allcmd', target: 'compute_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pcompute_tsload_busy_compute_tsload_7', source: 'pcompute_tsload_busy', target: 'compute_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_tsload_7_pcompute_done', source: 'compute_tsload_7', target: 'pcompute_done', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pcompute_tsload_start_compute_tsload_5', source: 'pcompute_tsload_start', target: 'compute_tsload_5', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_tsload_5_pcompute_tsload_busy', source: 'compute_tsload_5', target: 'pcompute_tsload_busy', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pcompute_tsload_allcmd_compute_tsload_4', source: 'pcompute_tsload_allcmd', target: 'compute_tsload_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pdpi_cap_compute_tsload_4', source: 'pdpi_cap', target: 'compute_tsload_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_compute_tsload_4_pcompute_tsload_inflight', source: 'compute_tsload_4', target: 'pcompute_tsload_inflight', label: 'output_token', functionBody: "    def output_token(binding):\n        req_len = int(binding[f\"{dependent_place.id}.0.req_len\"])\n        addr = binding[f\"{dependent_place.id}.0.addr\"]\n        tokens = deque()\n        for i in range(req_len):\n            tokens.append(Token(dict({\"addr\":addr})))\n        return tokens\n" } },
      { data: { id: 'e_compute_tsload_4_pdram_cmd', source: 'compute_tsload_4', target: 'pdram_cmd', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_out_tsload_6', source: 'pdram_out', target: 'tsload_6', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_tsload_6_ptsload_valid', source: 'tsload_6', target: 'ptsload_valid', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_req_queue_ready_dram_0', source: 'pdram_req_queue_ready', target: 'dram_0', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pdram_readData_dram_0', source: 'pdram_readData', target: 'dram_0', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_dram_0_pdram_idle', source: 'dram_0', target: 'pdram_idle', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_dram_0_pdpi_cap', source: 'dram_0', target: 'pdpi_cap', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pdram_req_queue_dram_1', source: 'pdram_req_queue', target: 'dram_1', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pdram_1_dram_1', source: 'pdram_1', target: 'dram_1', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_dram_1_pdram_2', source: 'dram_1', target: 'pdram_2', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_2_dram_2', source: 'pdram_2', target: 'dram_2', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return number \n" } },
      { data: { id: 'e_pdram_req_queue_dram_2', source: 'pdram_req_queue', target: 'dram_2', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_dram_2_pdram_1', source: 'dram_2', target: 'pdram_1', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_0_dram_3', source: 'pdram_0', target: 'dram_3', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_dram_3_pdram_out', source: 'dram_3', target: 'pdram_out', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_req_queue_ready_dram_10', source: 'pdram_req_queue_ready', target: 'dram_10', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_dram_10_pdram_0', source: 'dram_10', target: 'pdram_0', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_cmd_dram_enq_deq_valid', source: 'pdram_cmd', target: 'dram_enq_deq_valid', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_dram_enq_deq_valid_pdram_req_queue', source: 'dram_enq_deq_valid', target: 'pdram_req_queue', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pdram_req_queue_dram_deq', source: 'pdram_req_queue', target: 'dram_deq', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pdram_2_dram_deq', source: 'pdram_2', target: 'dram_deq', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return number \n" } },
      { data: { id: 'e_pdram_idle_dram_deq', source: 'pdram_idle', target: 'dram_deq', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_dram_deq_pdram_req_queue_ready', source: 'dram_deq', target: 'pdram_req_queue_ready', label: 'output_token', functionBody: "    def output_token(binding):\n        req_len = int(binding[f\"{dependent_place.id}.0.req_len\"])\n        addr = binding[f\"{dependent_place.id}.0.addr\"]\n        tokens = deque()\n        for i in range(req_len):\n            tokens.append(Token(dict({\"addr\":addr})))\n        return tokens\n" } },
      { data: { id: 'e_dram_deq_pdram_readData', source: 'dram_deq', target: 'pdram_readData', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pfetch_cmd_fetch_done', source: 'pfetch_cmd', target: 'fetch_done', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pfetch_done_fetch_done', source: 'pfetch_done', target: 'fetch_done', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pnumInsn_fetch_done', source: 'pnumInsn', target: 'fetch_done', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        # this dependences have to go away\n        key = f\"{dependent_place.id}.0.insn_count\"\n        # if key not in binding:\n        #     return -1 #unable to fire \n        return binding[key]  \n" } },
      { data: { id: 'e_fetch_done_psDrain', source: 'fetch_done', target: 'psDrain', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        num = binding[num_key]\n        # print(\"pass_var_token\", num)\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n        # print(\"length to produce\", len(tokens))\n        return tokens \n" } },
      { data: { id: 'e_fetch_done_pcontrol_prime', source: 'fetch_done', target: 'pcontrol_prime', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pfetch_0_fetch_tsload_8', source: 'pfetch_0', target: 'fetch_tsload_8', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_fetch_tsload_8_pfetch_tsload_allcmd', source: 'fetch_tsload_8', target: 'pfetch_tsload_allcmd', label: 'fetch_output_token', functionBody: "    def fetch_output_token(binding):\n\n        insn_count = binding[f\"{dependent_place.id}.0.insn_count\"]\n        maxtransfer = 16*64 #16cache*64bits \n        tokens = deque()\n        cmdToken = Token()\n        cmdToken.dir[\"req_len\"] = insn_count*2\n        cmdToken.dir[\"addr\"] = addr\n        tokens.append(cmdToken)\n        return tokens \n" } },
      { data: { id: 'e_fetch_tsload_8_pfetch_tsload_start', source: 'fetch_tsload_8', target: 'pfetch_tsload_start', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_ptsload_valid_fetch_tsload_9', source: 'ptsload_valid', target: 'fetch_tsload_9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pfetch_tsload_inflight_fetch_tsload_9', source: 'pfetch_tsload_inflight', target: 'fetch_tsload_9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_fetch_tsload_9_psink', source: 'fetch_tsload_9', target: 'psink', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pfetch_tsload_inflight_fetch_tsload_7', source: 'pfetch_tsload_inflight', target: 'fetch_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pfetch_tsload_allcmd_fetch_tsload_7', source: 'pfetch_tsload_allcmd', target: 'fetch_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pfetch_tsload_busy_fetch_tsload_7', source: 'pfetch_tsload_busy', target: 'fetch_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_fetch_tsload_7_pfetch_done', source: 'fetch_tsload_7', target: 'pfetch_done', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pfetch_tsload_start_fetch_tsload_5', source: 'pfetch_tsload_start', target: 'fetch_tsload_5', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_fetch_tsload_5_pfetch_tsload_busy', source: 'fetch_tsload_5', target: 'pfetch_tsload_busy', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pfetch_tsload_allcmd_fetch_tsload_4', source: 'pfetch_tsload_allcmd', target: 'fetch_tsload_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pdpi_cap_fetch_tsload_4', source: 'pdpi_cap', target: 'fetch_tsload_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_fetch_tsload_4_pfetch_tsload_inflight', source: 'fetch_tsload_4', target: 'pfetch_tsload_inflight', label: 'output_token', functionBody: "    def output_token(binding):\n        req_len = int(binding[f\"{dependent_place.id}.0.req_len\"])\n        addr = binding[f\"{dependent_place.id}.0.addr\"]\n        tokens = deque()\n        for i in range(req_len):\n            tokens.append(Token(dict({\"addr\":addr})))\n        return tokens\n" } },
      { data: { id: 'e_fetch_tsload_4_pdram_cmd', source: 'fetch_tsload_4', target: 'pdram_cmd', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pload_mem_load_tsload_8', source: 'pload_mem', target: 'load_tsload_8', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_tsload_8_pload_tsload_allcmd', source: 'load_tsload_8', target: 'pload_tsload_allcmd', label: 'output_token', functionBody: "    def output_token(binding):\n\n        subopcode = binding[f\"{dependent_place.id}.0.subopcode\"]\n        opcode = binding[f\"{dependent_place.id}.0.opcode\"]\n        tstype = binding[f\"{dependent_place.id}.0.tstype\"]\n        xsize = int(binding[f\"{dependent_place.id}.0.xsize\"])\n        ysize = int(binding[f\"{dependent_place.id}.0.ysize\"])\n\n        tsSize = 32\n        if opcode == \"compute\" and subopcode == \"loadUop\":\n            tsSize = 1*1*32\n        if opcode == \"compute\" and subopcode == \"loadAcc\":\n            tsSize = 1*16*32\n        if opcode == \"load\" and tstype == \"inp\":\n            tsSize = 1*16*8\n        if opcode == \"load\" and tstype == \"wgt\":\n            tsSize = 16*16*8\n\n        maxtransfer = 16*64 #16cache*64bits \n        one_row_size = tsSize*xsize\n        if one_row_size > maxtransfer:\n            remain_len = int(math.ceil(one_row_size % maxtransfer / 64))\n            datalen = int(maxtransfer/64)\n            cmd_times = int(one_row_size // maxtransfer)\n        else:\n            remain_len = 0\n            datalen = int(math.ceil(one_row_size/64))\n            cmd_times = 1 \n\n        tokens = deque()\n        for i in range(ysize) :\n            for j in range(cmd_times):\n                cmdToken = Token()\n                cmdToken.dir[\"req_len\"] = datalen\n                cmdToken.dir[\"addr\"] = addr\n                tokens.append(cmdToken)\n            if remain_len > 0:\n                cmdToken = Token()\n                cmdToken.dir[\"req_len\"] = remain_len\n                cmdToken.dir[\"addr\"] = addr\n                tokens.append(cmdToken)\n        return tokens\n" } },
      { data: { id: 'e_load_tsload_8_pload_tsload_start', source: 'load_tsload_8', target: 'pload_tsload_start', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_tsload_inflight_load_tsload_9', source: 'pload_tsload_inflight', target: 'load_tsload_9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_ptsload_valid_load_tsload_9', source: 'ptsload_valid', target: 'load_tsload_9', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_tsload_9_psink', source: 'load_tsload_9', target: 'psink', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_tsload_inflight_load_tsload_7', source: 'pload_tsload_inflight', target: 'load_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pload_tsload_allcmd_load_tsload_7', source: 'pload_tsload_allcmd', target: 'load_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return -2 \n" } },
      { data: { id: 'e_pload_tsload_busy_load_tsload_7', source: 'pload_tsload_busy', target: 'load_tsload_7', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_tsload_7_pload_done', source: 'load_tsload_7', target: 'pload_done', label: 'output_token', functionBody: "    def output_token(binding):\n        tokens = deque()\n        tokens.append(Token())\n        return tokens\n" } },
      { data: { id: 'e_pload_tsload_start_load_tsload_5', source: 'pload_tsload_start', target: 'load_tsload_5', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_tsload_5_pload_tsload_busy', source: 'load_tsload_5', target: 'pload_tsload_busy', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } },
      { data: { id: 'e_pload_tsload_allcmd_load_tsload_4', source: 'pload_tsload_allcmd', target: 'load_tsload_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_pdpi_cap_load_tsload_4', source: 'pdpi_cap', target: 'load_tsload_4', label: 'number_of_token', functionBody: "    def number_of_token(binding):\n        return 1 \n" } },
      { data: { id: 'e_load_tsload_4_pload_tsload_inflight', source: 'load_tsload_4', target: 'pload_tsload_inflight', label: 'output_token', functionBody: "    def output_token(binding):\n        req_len = int(binding[f\"{dependent_place.id}.0.req_len\"])\n        addr = binding[f\"{dependent_place.id}.0.addr\"]\n        tokens = deque()\n        for i in range(req_len):\n            tokens.append(Token(dict({\"addr\":addr})))\n        return tokens\n" } },
      { data: { id: 'e_load_tsload_4_pdram_cmd', source: 'load_tsload_4', target: 'pdram_cmd', label: 'output_token', functionBody: "    def output_token(binding):\n        # binded variables:\n        keys = from_place.type_annotations\n        # print(from_place.id, keys)\n        tokens = deque()\n        for i in range(num):\n            new_dir = dict()\n            # might be empty\n            for key in keys:\n                new_dir[key] = binding[f\"{from_place.id}.{i}.{key}\"]\n            tokens.append(Token(new_dir))\n\n        return tokens \n" } }
    ],
    style: [
      {
        selector: 'node[type="place"]',
        style: {
          'background-opacity': 0, 
          'background-color': 'transparent',
          'border-color': 'black',
          'border-width': 2,
          'label': 'data(id)'
        }
      },
      {
        selector: 'node[type="transition"]',
        style: {
          'background-opacity': 0, 
          'background-color': 'transparent',
          'border-color': 'black',
          'border-width': 2,
          'shape': 'polygon',
          'shape-polygon-points': '-0.5 -1 0.5 -1 0.5 1 -0.5 1', 
          'label': 'data(id)'
        }
      },
      {
        selector: 'edge',
        style: {
           'label': 'data(label)',
           'curve-style': 'bezier',
           'target-arrow-shape': 'triangle-backcurve',
           'line-color': 'grey',
           'target-arrow-color': 'grey',
           'width': '2px',
           'arrow-scale': 2

        }
      }
    ],
    
    layout: {
        name: 'cose',
        idealEdgeLength: 200,
        nodeOverlap: 20
    }
  });
  

   // Initial font size, shape size, and edge width
    var initialFontSize = 20;
    var initialShapeSize = 30;
    var initialEdgeWidth = 4;
    var initialBorderWidth = 2;
    var initialArrowScale = 2;

    cy.on('zoom', function(event) {
        var zoomLevel = cy.zoom();
        var newFontSize = initialFontSize / zoomLevel;
        var newShapeSize = initialShapeSize / zoomLevel;
        var newEdgeWidth = initialEdgeWidth / zoomLevel;
        var newBorderWidth = initialBorderWidth / zoomLevel;
        var newArrowScale = initialArrowScale / zoomLevel;
        
        cy.style()
        .selector('node')
        .style({
            'font-size': newFontSize + 'px',
            'width': newShapeSize + 'px',
            'height': newShapeSize + 'px',
            'border-width': newBorderWidth
        })
        .selector('edge')
        .style({
            'font-size': newFontSize + 'px',
            'width': newEdgeWidth,
            'text-opacity': 0,
            'arrow-scale': newArrowScale
        })
        .update();
    });

    function resetStyles() {
        cy.nodes().forEach(function(node) {
            node.style({
                'background-opacity': 0, 
                'background-color': 'transparent',
                'border-color': 'black',
                'border-width': 2,
                'border-opacity': 1,
                'text-opacity': 1
            });
        });
        cy.edges().forEach(function(edge) {
            edge.style({
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle',
                'line-color': 'grey',
                'target-arrow-color': 'grey',
                'width': '2px',
                'opacity': 1 
            });
        });
    }

    function dimAllNodes() {
        cy.nodes().forEach(function(node) {
        node.style({
            'background-color': 'transparent',
            'border-color': 'black',
            'border-opacity': 0.2,
            'text-opacity': 0.2
        });
        });
    }

    function dimAllEdges() {
        cy.edges().style({
            'line-color': 'grey',
            'text-opacity': 0,
            'opacity': 0.2 
        });
    }

    function highlightConnectedEdges(node) {
        node.connectedEdges().style({
            'line-color': 'grey',
            'text-opacity': 1,
            'opacity': 1
        });
    }


    function highlightNode(node) {
        node.style({
            'background-opacity': 0, 
            'background-color': 'transparent',
            'border-color': 'black',
            'border-width': 2,
            'border-opacity': 1,
            'text-opacity': 1
        });
        node.connectedEdges().forEach(function(edge) {
        edge.connectedNodes().forEach(function(connectedNode) {
            connectedNode.style({
            'background-opacity': 0, 
            'background-color': 'transparent',
            'border-color': 'black',
            'border-width': 2,
            'border-opacity': 1,
            'text-opacity': 1
            });
        });
        edge.style({ 'text-opacity': 1 });  // Show edge label
        });
    }
    
    cy.on('tap', 'node', function(event) {
        resetStyles();  // Reset all nodes to their default style
        dimAllNodes();  // Dim all nodes
        dimAllEdges();  // Dim all edges
        var tappedNode = event.target;
        highlightNode(tappedNode);  // Highlight the tapped node and its connected nodes
        highlightConnectedEdges(tappedNode);  // Highlight edges connected to the tapped node
    });

    cy.on('tap', 'edge', function(evt){
        const edge = evt.target;
        console.log("Function Body: ", edge.data('functionBody'));
        const functionName = edge.data('label');
        const functionBody = edge.data('functionBody');  // Assuming you've stored the function body here
        document.getElementById('functionInfo').innerText = `Function: ${functionName}

Body:
${functionBody}`;
    });
    
    cy.on('tap', function(event) {
        if (event.target === cy) {
            resetStyles();
        }
    });

    function handleSearch() {
      const searchBox = document.getElementById('searchBox');
      searchBox.addEventListener('input', function() {
        const query = searchBox.value;
        resetStyles();  // Reset styles before highlighting new node

        if (query) {
          const node = cy.getElementById(query);
          if (node.length) {  // Check if node exists
            resetStyles();  // Reset all nodes to their default style
            dimAllNodes();  // Dim all nodes
            dimAllEdges();  // Dim all edges
            highlightNode(node);
            highlightConnectedEdges(node);
          }
        }
      });
    }

    handleSearch();

</script>

</body>
</html>